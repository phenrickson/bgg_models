---
title: "Predicting Upcoming Board Games"
author: "Phil Henrickson"
date: "`r Sys.Date()`"
output: html_document:
        number_sections: FALSE

---

```{r setup, include=FALSE, echo = F}

knitr::opts_chunk$set(echo = F)

source(here::here("src", "reports", "knitr_settings.R"))

# load in tables needed
tar_load(
        games_imputed
)

tar_load(
        end_train_year
)

tar_load(
        games
)

tar_load(
        games_predicted
)

add_gt_predictions_header = function(gt,
                                     title = 'Top Upcoming Games',
                                     subtitle = 
                                             paste('Displaying estimated BoardGameGeek ratings for upcoming board games. Games ranked based on estimated geek rating, which is a combination of their estimated average rating and estimated number of user ratings. Predictions from models trained on games released through', end_train_year),
                                     ...) {
        
        gt %>%
                gt::tab_header(
                        title,
                        subtitle
                )
}

```

# Top Games

Which upcoming board games are expected to be highly rated on BoardGameGeek (BGG)? I trained a series predictive models on historical games in order to estimate how the BGG community is likely to rate upcoming games. The following tables display predictions from those models, sorting games based on their estimated BGG (geek) rating.

For more details...

## Overall

```{r overall}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        )
# ) %>%
# add_gt_predictions_header()

```


## `r end_train_year + 1`

```{r predictions t plus 1}

games_predicted %>%
        filter(yearpublished == end_train_year+1) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) 
# %>%
#         add_gt_predictions_header(
#                 title = paste('Top Upcoming Games', end_train_year +1, sep = " - ")
#         )

```

## `r end_train_year +2`

```{r predictions t plus 2}

games_predicted %>%
        filter(yearpublished == end_train_year+2) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = paste('Top Upcoming Games', end_train_year +2, sep = " - ")
        )

```

## `r end_train_year + 3`

```{r predictions t plus 3}

games_predicted %>%
        filter(yearpublished == end_train_year+3) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        )
# %>%
#         add_gt_predictions_header(
#                 title = paste('Top Upcoming Games', end_train_year +3, sep = " - ")
#         )
```


# Top Games by Category

## Economic

```{r economic}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Economic') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Economic Games',
                subtitle = ''
        )

```

## War

```{r war}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Wargame') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming War Games',
                subtitle = ''
        )

```

### Abstract

```{r abstract }

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Abstract Strategy') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Abstract Games',
                subtitle = ''
        )


```

### Party

```{r party}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Party Game') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Party Games'
        )

```

### Dexterity

```{r dexterity}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Action / Dexterity') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Action / Dexterity'
        )

```

### Two Player

```{r two player}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, families) %>%
                                       unnest(families)  %>%
                                       filter(family_value == 'Two Player Only Games') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Two Player Only Games'
        )

```


### Card

```{r}


games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Card Game') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Card Games'
        )

```

### Dice

```{r}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Dice') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Dice Games'
        )


```


## Genre

### Fantasy

```{r fantasy}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Fantasy') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Fantasy Games'
        )


```


### Science Fiction

```{r sci fi}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Science Fiction') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Science Fiction Games'
        )


```

### Adventure

```{r adventure}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Adventure') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Adventure Games'
        )

```

### Miniatures

```{r}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, families) %>%
                                       unnest(families)  %>%
                                       filter(family_value == 'Miniatures') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Miniatures Games'
        )

```





### Racing

```{r}

games_predicted %>%
        filter(yearpublished > end_train_year) %>%
        filter(game_id %in%
                       (
                               games %>%
                                       select(game_id, name, categories) %>%
                                       unnest(categories)  %>%
                                       filter(value == 'Racing') %>%
                                       pull(game_id)
                       )
        ) %>%
        make_predictions_gt_table(
                predictions =.,
                game_data = games,
                top_n = 25
        ) %>%
        add_gt_predictions_header(
                title = 'Top Upcoming Racing Games'
        )

```

# All Predictions

```{r}

geek_cuts = 
        c(4, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5)

average_cuts = 
        c(0, 1, 3, 4, 5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 10)

averageweight_cuts = 
        c(1, 1.5, seq(2, 5, by = .1))

ratings_cuts = 
        c(0, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 25000, 50000, 100000)

rating_color_ramp = 
        colorRampPalette(c("red", "white", "dodgerblue2"))

ratings_color_ramp = 
                colorRampPalette(c("white", "dodgerblue2"))

averageweight_color_ramp = 
        colorRampPalette(c("white", "darkorange"))

games_predicted %>%
        filter(type == 'upcoming') %>%
        select(game_id, name, yearpublished,
               starts_with(".pred")) %>%
        arrange(desc(.pred_bayesaverage)) %>%
        mutate(
                across(starts_with(".pred"),
                       round, 2)
        ) %>%
        mutate(name = make_hyperlink(make_bgg_link(game_id), mytext = str_trunc(name, width = 40))) %>%
        mutate(yearpublished = factor(yearpublished)) %>%
        select(
                Published = yearpublished,
                Name = name,
                `Geek Rating` = .pred_bayesaverage,
                `Average Weight` = .pred_averageweight,
                `Average Rating` = .pred_average,
                `User Ratings` = .pred_usersrated) %>%
        DT::datatable(
                escape = F,
                rownames = T,
                selection = 'none',
                extensions = c('Responsive'),
                #  caption = "Games",
                class = list(stripe =F),
                filter = list(position = 'top'),
                options = list(pageLength = 25,
                               initComplete = 
                                       htmlwidgets::JS(
                                               "function(settings, json) {",
                                               paste0("$(this.api().table().container()).css({'font-size': '", '10pt', "'});"),
                                               "}"),
                               scrollX=T,
                               scrollY =T,
                               autowidth=T,
                               info = F,
                               columnDefs = 
                                       list(
                                               list(className = 'dt-center',
                                                    visible=T,
                                                    targets=c(
                                                            "Published",
                                                            "Geek Rating",
                                                            "Average Weight",
                                                            "Average Rating",
                                                            "User Ratings")
                                               )
                                       )
                )
        ) %>%
        DT::formatStyle(
                columns = 'Geek Rating',
                backgroundColor = 
                        DT::styleInterval(
                                cuts = geek_cuts,
                                values = rating_color_ramp(length(geek_cuts)+1)
                        )
        ) %>%
        DT::formatStyle(
                columns = 'Average Rating',
                backgroundColor = 
                        DT::styleInterval(
                                cuts = average_cuts,
                                values = rating_color_ramp(length(average_cuts)+1)
                        )
        ) %>%
        DT::formatStyle(
                columns = 'Average Weight',
                backgroundColor = 
                        DT::styleInterval(
                                cuts = averageweight_cuts,
                                values = averageweight_color_ramp(length(averageweight_cuts)+1)
                        )
        ) %>%
        DT::formatStyle(
                columns = 'User Ratings',
                backgroundColor = 
                        DT::styleInterval(
                                cuts = ratings_cuts,
                                values = ratings_color_ramp(length(ratings_cuts)+1)
                        )
        )

```

