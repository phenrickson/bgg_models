---
title: "Predicting Upcoming Board Games"
subtitle: "Predictive Models for BoardGameGeek Ratings"
editor: source
echo: false
---

```{r}
#| include: false
#| label: load packages and targets
library(dplyr)
library(bggUtils)
library(tidymodels)
library(vetiver)
library(gert)
library(qs2)
library(quarto)
library(targets)
library(tarchetypes)

# load src code
tar_source("src")

# project settings
config <- config::get()

# authenticate
authenticate_to_gcs()

# load in objects from pipeline
tar_load(valid_predictions)
tar_load(valid_metrics)
tar_load(details)
tar_load(hurdle_threshold)
tar_load(valid_hurdle_metrics)
tar_load(hurdle_results)

# find valid_years
valid_years =
    valid_predictions |>
    summarize(min_year = min(yearpublished), max_year = max(yearpublished))

# set ggplot theme
theme_set(bggUtils::theme_bgg())
```

```{r}
#| include: false
#| label: load games from gcs

# load games from gcp
games_raw =
    get_games_from_gcp(bucket = "bgg_data")

# prepare games with preprocessor
games =
    games_raw |>
    prepare_games()
```

```{r}
#| message: false
#| warning: false
#| label: load predictions

# read in predictions
board = pins::board_folder("data/processed")
predictions = pins::pin_read(board, name = "predictions") |>
    inner_join(games)

```

# Models

I use historical data from BoardGameGeek (BGG) to train a number of predictive models for community ratings. I first classify games based on their probability of achieving a minimum number of ratings on BGG. I then estimate each game's complexity (average weight) in order to predicts its number of user ratings and average rating. I then use these estimates to predict the expected Geek Rating.

```{r}
#| message: false
#| warning: false
#| label: filter to upcoming games

end_valid_year = valid_years$max_year

upcoming_games =
    games |>
    filter(yearpublished > end_valid_year)

```

## Upcoming Games

The following table displays predicted BGG outcomes for games that are expected to achieve at least 25 user ratings.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: upcoming-games-table
#| column: page-inset-right

# table
predictions |>
    filter(.pred_hurdle_class == 'yes') |>
    select(-starts_with(".pred_hurdle")) |>
    # this goddamn bah humbug game
    filter(game_id != 388225) |>
    predictions_dt(
        games = games,
        lazy_load = TRUE,
        pageLength = 10
    ) |>
    add_colors()

```

## Hurdle

This table displays predicted probabilities for whether games will achieve enough ratings (25) to be assigned a Geek Rating

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: hurdle-table
#| column: page-inset-right

predictions |>
    filter(.pred_hurdle_class == 'yes') |>
    hurdle_dt(
        lazy_load = TRUE
    )

```